<!-- A simple top bar to match style of "Proposer une idée" / "Voter pour idée" pages -->
<div class="topbar">
    <button pButton label="Proposer une idée" styleClass="p-button-outlined"></button>
    <button pButton label="Voter pour une idée" class="ml-2"></button>
</div>

<div class="col-12 mt-3">
    <div class="card">
        <h5>Liste des Projets (Row Expand + Filter by Region)</h5>

        <!-- Toast for messages (optional) -->
        <p-toast></p-toast>

        <!-- Dropdown filter for region -->
        <div class="flex align-items-center mb-2">
            <label class="mr-2">Filtrer par région:</label>
            <p-dropdown
                [options]="regions"
                [(ngModel)]="selectedRegion"
                placeholder="Toutes les régions"
                optionLabel="label"
                class="p-column-filter"
            ></p-dropdown>
        </div>

        <!-- Table with row expansion -->
        <p-table
            [value]="filteredProjects"
            dataKey="name"
            [expandedRowKeys]="expandedRows"
            responsiveLayout="scroll"
        >
            <!-- Table caption with expand/collapse button -->
            <ng-template pTemplate="caption">
                <button
                    pButton
                    icon="pi pi-fw {{ isExpanded ? 'pi-minus' : 'pi-plus' }}"
                    label="{{ isExpanded ? 'Collapse All' : 'Expand All' }}"
                    (click)="expandAll()"
                ></button>
            </ng-template>

            <!-- Table header -->
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 3rem"></th>
                    <th pSortableColumn="name">Name <p-sortIcon field="name"></p-sortIcon></th>
                    <th pSortableColumn="title">Title <p-sortIcon field="title"></p-sortIcon></th>
                    <th pSortableColumn="region">Region <p-sortIcon field="region"></p-sortIcon></th>
                    <th pSortableColumn="status">Status <p-sortIcon field="status"></p-sortIcon></th>
                    <th pSortableColumn="start_date">Start Date <p-sortIcon field="start_date"></p-sortIcon></th>
                    <th pSortableColumn="end_date">End Date <p-sortIcon field="end_date"></p-sortIcon></th>
                </tr>
            </ng-template>

            <!-- Table body -->
            <ng-template pTemplate="body" let-project let-expanded="expanded">
                <tr>
                    <td>
                        <button
                            type="button"
                            pButton
                            pRipple
                            [pRowToggler]="project"
                            class="p-button-text p-button-rounded p-button-plain"
                            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                        ></button>
                    </td>
                    <td style="min-width: 12rem;">{{ project.name }}</td>
                    <td style="min-width: 12rem;">{{ project.title }}</td>
                    <td style="min-width: 8rem;">{{ project.region }}</td>
                    <td style="min-width: 10rem;">{{ project.status }}</td>
                    <td style="min-width: 10rem;">{{ project.start_date | date: 'yyyy-MM-dd' }}</td>
                    <td style="min-width: 10rem;">{{ project.end_date | date: 'yyyy-MM-dd' }}</td>
                </tr>
            </ng-template>

            <!-- Row expansion template (comments + description) -->
            <ng-template pTemplate="rowexpansion" let-project>
                <tr>
                    <td colspan="7">
                        <div class="p-3">
                            <h6>Description du projet</h6>
                            <p>{{ project.description }}</p>

                            <h6 class="mt-3">Commentaires</h6>
                            <!-- Display existing comments -->
                            <ul style="list-style-type: none; padding: 0;">
                                <li *ngFor="let c of project.comments">
                                    <i class="pi pi-comment mr-2"></i>{{ c }}
                                </li>
                            </ul>

                            <!-- Add new comment -->
                            <div class="flex align-items-center mt-2">
                                <p-inputTextarea
                                    [(ngModel)]="newCommentText"
                                    placeholder="Ajouter un commentaire"
                                    rows="2"
                                    cols="40"
                                ></p-inputTextarea>
                                <button
                                    pButton
                                    label="Envoyer"
                                    icon="pi pi-send"
                                    class="ml-2"
                                    (click)="addComment(project, newCommentText); newCommentText = '';"
                                ></button>
                            </div>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <!-- If no projects match the filter, show empty message -->
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7">Aucun projet trouvé pour cette région.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>
